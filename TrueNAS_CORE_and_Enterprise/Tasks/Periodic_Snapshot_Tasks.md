# 定期快照任务

定期快照任务允许安排在给定时间点创建只读版本的池和数据集。

快照不会制作数据的副本，因此创建快照非常快，如果更改的数据很少，它们占用的空间也很小。 通常每 15 分钟拍摄一次频繁的快照，即使对于大型活动池也是如此。 未更改文件的快照不占用存储空间，但随着文件发生更改，快照大小会发生变化以反映更改的大小。 以与所有池数据相同的方式，删除对数据的最后一个引用后，您将恢复空间。

快照保留了文件的历史记录，提供了一种恢复旧副本甚至已删除文件的方法。 出于这个原因，许多管理员经常拍摄快照，将它们存储一段时间，然后将它们存储在另一个系统上，通常使用复制任务。 这种策略允许管理员将系统回滚到特定时间点。 如果发生灾难性丢失，异地快照可以将数据恢复到上次快照的时间。

## 创建周期性快照任务

在创建快照任务之前，任何必需的数据集或 zvol 都必须存在。

### 创建过程

转至任务（**Tasks**） > 定期快照任务（**Periodic Snapshot Tasks**），然后单击添加（**ADD**）。

![](https://www.truenas.com/docs/images/CORE/12.0/TasksPeriodicSnapshotAdd.png)

选择数据集（或 zvol）作为定期备份快照，以及选择存储快照多长时间。 也可以定义任务计划。 如果您需要特定计划，请选择自定义并使用高级计划程序。

#### 高级调度

![](https://www.truenas.com/docs/images/CORE/12.0/TasksAdvancedScheduler.png)

选择预设会填充其余字段。要自定义计划，请按照`Minutes/Hours/Days`输入 [crontab](https://www.freebsd.org/cgi/man.cgi?crontab%285%29) 值。

请填写标准的 cron 值。最简单的选择是在字段中输入一个数字。当时间值与该数字匹配时，任务将运行。例如，输入 10 表示任务在时间过十分钟时运行。

星号 (*) 表示“匹配所有值”。

通过输入带连字符的数字值来设置特定的时间范围。例如，在“分钟”（**Minutes**）字段中输入 30-35 会将任务设置为在 30、31、32、33、34 和 35 分钟运行。

也可以输入值列表。输入由逗号 (,) 分隔的各个值。例如，在“小时”（**Hours**）字段中输入 1,14 表示任务在凌晨 1:00 (0100) 和下午 2:00 (1400) 运行。

斜线 (/) 表示步长值。例如，在 "日期"（**Days**） 中输入 * 表示该任务在每月的每一天运行，*/2 表示该任务每隔一天运行一次。

将上述所有示例结合在一起，可以创建一个计划，在每天凌晨 1:30-1:35 和下午 2:30-2:35 每分钟运行一次任务。

有一个选项可以选择任务运行的月份。不设置每个月与选择每个月相同。

星期几安排任务在特定的日子运行。这是对任何列出的天数的补充。例如，在日期中输入 1 并将 **Wed** 设置为 **Days of Week** 会创建一个计划，该计划在每月的第一天和每月的每个星期三启动任务。

计划预览（**Schedule Preview**）显示当前设置的任务运行的时间。

##### CRON 语法示例

| 句法                | 含义                                                       | 例子                                                         |
| ------------------- | ---------------------------------------------------------- | ------------------------------------------------------------ |
| *                   | 每一项。                                                   | * (minutes) = 每小时的每个特定分钟. * (days) = 每天.         |
| */N                 | 每 N 个项目                                                | */15 (minutes) = 每小时的第 15 分钟（每刻钟）。 */3 (days) = 每 3 天。 */3 (months) = 每三个月一次。 |
| 逗号和连字符/破折号 | 每个陈述的项目（逗号） 范围内的每个项目（连字符/破折号）。 | 1,31 (minutes) = 在每小时的第 1 分钟和第 31 分钟。 1-3,31 (minutes) = 每小时的第 1 分钟到第 3 分钟，以及第 31 分钟。 mon-fri (days) = 每周一至周五（包括每个工作日）。 mar,jun,sep,dec (months) = 每年三月、六月、九月、十二月。 |

天数可以指定为一个月的天数或一周的天数。

使用这些选项，可以创建类似于以下示例的灵活计划：

| 想要的时间表                                                 | 要输入的值                                                   |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 每天 3 次（午夜、08:00 和 16:00）                            | months=*; days=*; hours=0/8 or 0,8,16; minutes=0 (Meaning: every day of every month, when hours=0/8/16 and minutes=0) |
| 每周一、周三和周五，晚上 8.30                                | months=*; days=mon,wed,fri; hours=20; minutes=30             |
| 每月的第 1 天和第 15 天，10 月至 6 月，上午 00:01            | months=oct-dec,jan-jun; days=1,15; hours=0; minutes=1        |
| 工作日内每 15 分钟一次，即周一至周五上午 8 点至晚上 7 点（08:00 - 19:00） | Note that this requires two tasks to achieve: (1) months=*; days=mon-fri; hours=8-18; minutes=*/15 (2) months=*; days=mon-fri; hours=19; minutes=0 We need the second scheduled item, to execute at 19:00, otherwise we would stop at 18:45. Another workaround would be to stop at 18:45 or 19:45 rather than 19:00. |

为您的快照实例配置其余选项。

### 具体选项

#### 数据集

| 选项名称              | 描述                                                         |
| --------------------- | ------------------------------------------------------------ |
| 数据集（**Dataset**） | 选择池、数据集或 zvol。                                      |
| 递归（**Recursive**） | 勾选为拍摄数据集及其每个子数据集的单独快照。 保留未勾选以仅拍摄指定数据集的单个快照，而没有子数据集。 |
| 排除（**Exclude**）   | 从快照中排除特定的子数据集。 与递归（**Recursive**）一起使用。 列出要排除的任何子数据集的路径。 示例：`pool1/dataset1/child1`。 pool1/dataset1 的递归快照将包括除 child1 之外的所有子数据集。 按 Enter 分隔条目。 |

#### 日程安排

| 选项名称                                           | 描述                                                         |
| -------------------------------------------------- | ------------------------------------------------------------ |
| 快照保存时间（**Snapshot Lifetime**）              | 使用数值和单位的单个小写字母定义在此系统上保留快照的时间长度。 示例：*3h* 是三个小时，*1m* 是一个月，*1y* 是一年。 不接受分钟值。 时间到期后，快照将被删除。 已复制到其他系统的快照不受影响。 |
| 命名格式（**Naming Schema**）                      | 快照名称格式字符串。 默认值为“auto-%Y-%m-%d_%H-%M”。 必须包含字符串 `%Y`、`%m`、`%d`、`%H` 和 `%M`，它们被替换为四位数的年、月、月中的某一天、小时和分钟 如 [strftime(3)](https://www.freebsd.org/cgi/man.cgi?query=strftime) 中所定义。 例如，具有`customsnap-%Y%m%d.%H%M` 命名架构的*pool1* 快照的名称类似于*[pool1@customsnap-20190315.0527](mailto:pool1@customsnap-20190315.0527)*。 |
| 快照日程（**Schedule**）                           | 选择预设之一或*自定义*以使用高级调度程序。                   |
| 允许拍摄空快照（**Allow Taking Empty Snapshots**） | 即使上次快照中的数据集没有更改，也可以创建数据集快照。 推荐用于长期还原点、指向同一数据集的多个快照任务，或与 TrueNAS 11.2 及更早版本中创建的快照计划或复制的兼容性。 例如，允许每月快照计划的空快照允许拍摄每月快照，即使每日快照任务已经拍摄了对数据集的任何更改的快照。 |
| 启用（**Enabled**）                                | 要激活此定期快照计划，请勾选此选项。 要禁用此任务而不删除它，请取消勾选此选项。 |

#### 命名格式（**Naming Schema**）

命名架构决定了自动快照名称的生成方式。 有效的架构需要 %Y（年）、%m（月）、%d（天）、%H（小时）和 %M（分钟）时间字符串，但您也可以向架构添加更多标识符，使用 来自 Python [strptime](https://docs.python.org/3/library/datetime.html#strftime-and-strptime-behavior) 函数的任何标识符。

这使用与 POSIX (Unix) 时间函数不同的一些字母。 例如，包含 %z（时区）可确保快照在夏令时开始和结束时不会出现命名冲突，而 %S（秒）则增加了更精细的时间粒度。

例子：

| 命名格式                              | 生成的快照名称实例                                           |
| ------------------------------------- | ------------------------------------------------------------ |
| replicationsnaps-1wklife-%Y%m%d_%H:%M | `replicationsnaps-1wklife-20210120_00:00`, `replicationsnaps-1wklife-20210120_06:00` |
| autosnap_%Y.%m.%d-%H.%M.%S-%z         | `autosnap_2021.01.20-00.00.00-EST`, `autosnap_2021.01.20-06.00.00-EST` |

注意：从 Windows 计算机引用快照时，请避免使用在 Windows 文件路径中无效的字符，例如：. 某些应用程序限制文件名或路径长度，并且可能存在与空格和其他字符相关的限制。 始终考虑未来的用途并确保为定期快照指定的名称有最大兼容性。

#### 快照保存时间（Snapshot Lifetime）

TrueNAS 会在快照保存时间结束时删除快照，并在至少一项定期任务需要时保留快照。 例如，您创建了两个计划，其中一个计划每小时拍摄一次快照并保留一周，另一个计划每天拍摄一次快照并保留 3 年。 每个人每小时拍摄一次快照。 一周后，在 01:00 到 23:00 创建的快照将被删除，但对于第二个计划来说， 这些每天拍摄一次的快照将在 3 年结束时被销毁。

单击提交（**SUBMIT**）以保存此任务并将其添加到任务（**Tasks**） > 定期快照任务（**Periodic Snapshot Tasks**）中的列表中。 您可以在存储（**Storage**） > 快照（**Snapshots**）中找到拍摄的快照并且在任何时间恢复它们。

要查看已保存快照计划的日志，请转至任务（**Tasks**） > 定期快照任务（**Periodic Snapshot Tasks**）并单击任务状态（**State**）。


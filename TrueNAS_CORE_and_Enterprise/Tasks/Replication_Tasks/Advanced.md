# 高级复制任务

要求：

包含要创建快照的数据集和数据的存储池。
已经配置了到远程系统的SSH连接，保存在系统（**System**） > SSH 连接（**SSH Connections**）中。
已经配置了保存在任务（**Tasks** ） > 定期快照任务（**Periodic Snapshot Tasks**）中的数据集快照任务。

## 流程总结

转至任务（**Tasks**） > 复制任务（**Replication Tasks**），然后单击添加（**ADD**），然后选择创建高级复制任务（**ADVANCED REPLICATION CREATION**）。

- 常规选项:
  - 任务名称.
  - 为本地系统选择 Push 或 Pull.
  - 选择复制传输方法.
    - 建议使用 SSH。
    - 在安全网络中使用SSH+Netcat。
    - 本地用于系统内复制。
- 配置复制传输方法：
  - 远程选项需要 SSH 连接。
  - SSH+Netcat 需要定义netcat 端口和地址。
- 来源：
  - 选择复制源。
  - 选择定期快照任务作为要复制的快照源。
  - 远程源需要定义快照命名模式。
- 目标地址：
  - 远程目标需要 SSH 连接。
  - 选择目的地或在字段中输入路径。
  - 定义在目标中保留快照的时间。
- 日程计划：
  - 在相关的定期快照任务完成后，Run 会自动启动复制。
  - 要根据其自己的计划自动执行任务，请设置该选项并定义复制任务的计划。

## 创建高级复制任务

要使用高级编辑器创建复制任务，请转至任务（**Tasks**） > 复制任务（**Replication Tasks**），单击添加（**ADD**）以打开向导，然后单击创建高级复制（**ADVANCED REPLICATION CREATION**）。

![](https://www.truenas.com/docs/images/CORE/12.0/TasksReplicationAddAdvanced.png)

选项按类别分组在一起。 根据您所做的配置选择，选项可以出现、消失或被禁用。 在配置复制源和目标之前，首先配置常规选项，然后是传输选项。

为任务命名。 每个任务名称必须是唯一的，我们建议您以易于记住任务正在执行的操作的方式命名。

在配置其他部分之前，选择本地系统是发送 (Push) 还是接收数据 (Pull) 并决定使用哪种传输方法进行复制。

## 创建向导选项

### 传输选项

传输（**Transport**）选择器确定用于复制的方法：SSH 是从远程系统发送或接收数据的标准选项，但 SSH+NETCAT 可作为在完全安全的网络中进行的复制的更快选项。 本地仅用于将数据复制到同一系统上的另一个位置。

对于基于 SSH 的复制，通过选择到将发送或接收快照的远程系统的 SSH 连接（***SSH Connection***）来配置传输方法。 可以使用压缩数据、添加带宽限制或其他数据流自定义选项。 流压缩（**Stream Compression**）选项仅在使用 SSH 时可用。 在启用压缩写入记录之前，请确认目标系统也支持压缩写入记录。

![](https://www.truenas.com/docs/images/CORE/12.0/TasksReplicationAddAdvancedTransportOptions.png)

对于 SSH+NETCAT 复制，您还需要定义用于 Netcat 连接的地址和端口。

允许块大于 128KB 是一种单向切换。 只要此选项保持启用状态，使用大块复制的复制任务就会继续工作。

### 来源

复制源是用于复制的数据集或 zvol。 通过打开文件浏览器或在字段中输入数据集名称，选择要用于此复制任务的源。 从远程源拉取快照需要有效的 SSH 连接（**SSH Connection**），然后文件浏览器才能显示任何目录。 如果文件浏览器在选择正确的 SSH 连接（**SSH Connection**）后显示连接错误，您可能需要登录远程系统并确保将其配置为允许 SSH 连接（**SSH Connection**）。 在 TrueNAS 中，这需要转到“服务”（ **Services**）屏幕、检查 SSH 服务配置并启动服务来完成的。

![](https://www.truenas.com/docs/images/CORE/12.0/TasksReplicationAddAdvancedSource.png)

默认情况下，复制任务将使用快照将数据快速传输到接收系统。设置完整文件系统复制（**Full Filesystem Replication**）后，将完全复制所选源，包括所有数据集属性、快照、子数据集和克隆。选择此选项时，建议为复制任务的运行分配额外的时间。不设置完整文件系统复制（**Full Filesystem Replication**）但设置包括数据集属性（**Include Dataset Properties**）将仅包括要复制的快照中的数据集属性。其他选项允许您递归复制子数据集快照或从复制中排除特定子数据集或属性。

本地源由从定期快照任务和/或从与手动创建的快照匹配的定义命名模式生成的快照进行复制。远程源需要输入快照命名模式来标识要复制的快照。命名模式是 [strftime](https://www.freebsd.org/cgi/man.cgi?query=strftime) 时间和日期字符串以及用户可能已添加到快照名称的任何标识符的集合。例如，输入命名架构 [custom-%Y-%m-%d_%H-%M](https://www.freebsd.org/cgi/man.cgi?query=strftime) 会查找并复制像 custom-2020-03-25_09-15 这样的快照。可以通过按 Enter 键分隔每个模式来输入多个模式。

要从周期性任务定义特定快照以用于复制，请设置复制特定快照并输入计划。将包含在复制任务中的唯一定期生成的快照是那些与您定义的计划相匹配的快照。或者，您可以使用复制计划通过设置自动运行、仅复制快照匹配计划和定义复制任务的运行时间来确定复制哪些快照。

当复制任务难以完成时，最好设置 Save Pending Snapshots。这可以防止源 TrueNAS 自动删除无法复制到目标系统的任何快照。

### 目标地址

目的地是存储复制数据的地方。 选择远程目标需要到该系统的 SSH 连接。 展开文件浏览器会显示目标系统上可用的当前数据集。 您可以单击目的地或在字段中手动键入路径。 在路径末尾添加名称会在该位置创建一个新数据集。

注意：不要将远程目标设置为 zvols 。

![](https://www.truenas.com/docs/images/CORE/12.0/TasksReplicationAddAdvancedDestination.png)

默认情况下，目标数据集在复制完成后会被设置为只读（**read-only**）。 您可以将目标数据集只读策略（**Destination Dataset Read-only Policy**）更改为仅在目标为只读 (REQUIRE) 时启动复制或禁用检查数据集的只读状态 (IGNORE)。

加密通过在传输之前加密数据并在目标系统上解密数据，为复制的数据增加了另一层安全性。 设置复选框会添加更多选项以在使用十六进制密钥或定义您自己的加密密码之间进行选择。 加密密钥既可以存储在 TrueNAS 系统数据库中，也可以存储在自定义位置。

将目标快照与源同步会破坏目标中与源快照不匹配的任何快照。 TrueNAS 还会对源快照进行完整复制，就好像复制任务以前从未运行过一样，这可能会导致带宽消耗过多。 这可能是一个非常具有破坏性的选项，因此请确保将从目标中删除的任何快照都已过时或以其他方式备份到其他位置。

通常建议定义快照保留策略（**Snapshot Retention Policy**），以防止系统被过时的快照弄乱。 选择与源相同将在目标系统上保留快照的时间与源系统定期快照任务中定义的快照保存相同。 您还可以为目标系统上的快照定义自己的自定保存时间。

### 日程安排

默认情况下，将任务设置为“自动运行”（**Run Automatically**）会在相关周期性快照任务完成后立即启动复制。

设置 Schedule 复选框允许将复制安排在单独的时间运行。 必须为要运行的复制任务定义特定时间。 建议选择一个时间范围，既可以为复制任务提供足够的时间来完成，又可以在一天中源和目标系统的网络流量最小的时间段内进行。 当您需要微调复制的确切时间或日期时，建议使用自定义调度程序。

### 高级计划程序

![](https://www.truenas.com/docs/images/CORE/12.0/TasksAdvancedScheduler.png)

选择预设会填充其余字段。要自定义计划，请按照`Minutes/Hours/Days`输入 [crontab](https://www.freebsd.org/cgi/man.cgi?crontab%285%29) 值。

请填写标准的 cron 值。最简单的选择是在字段中输入一个数字。当时间值与该数字匹配时，任务将运行。例如，输入 10 表示任务在时间过十分钟时运行。

星号 (*) 表示“匹配所有值”。

通过输入带连字符的数字值来设置特定的时间范围。例如，在“分钟”（**Minutes**）字段中输入 30-35 会将任务设置为在 30、31、32、33、34 和 35 分钟运行。

也可以输入值列表。输入由逗号 (,) 分隔的各个值。例如，在“小时”（**Hours**）字段中输入 1,14 表示任务在凌晨 1:00 (0100) 和下午 2:00 (1400) 运行。

斜线 (/) 表示步长值。例如，在 "日期"（**Days**） 中输入 * 表示该任务在每月的每一天运行，*/2 表示该任务每隔一天运行一次。

将上述所有示例结合在一起，可以创建一个计划，在每天凌晨 1:30-1:35 和下午 2:30-2:35 每分钟运行一次任务。

有一个选项可以选择任务运行的月份。不设置每个月与选择每个月相同。

星期几安排任务在特定的日子运行。这是对任何列出的天数的补充。例如，在日期中输入 1 并将 **Wed** 设置为 **Days of Week** 会创建一个计划，该计划在每月的第一天和每月的每个星期三启动任务。

计划预览（**Schedule Preview**）显示当前设置的任务运行的时间。

#### CRON 语法示例

| 句法                | 含义                                                       | 例子                                                         |
| ------------------- | ---------------------------------------------------------- | ------------------------------------------------------------ |
| *                   | 每一项。                                                   | * (minutes) = 每小时的每个特定分钟. * (days) = 每天.         |
| */N                 | 每 N 个项目                                                | */15 (minutes) = 每小时的第 15 分钟（每刻钟）。 */3 (days) = 每 3 天。 */3 (months) = 每三个月一次。 |
| 逗号和连字符/破折号 | 每个陈述的项目（逗号） 范围内的每个项目（连字符/破折号）。 | 1,31 (minutes) = 在每小时的第 1 分钟和第 31 分钟。 1-3,31 (minutes) = 每小时的第 1 分钟到第 3 分钟，以及第 31 分钟。 mon-fri (days) = 每周一至周五（包括每个工作日）。 mar,jun,sep,dec (months) = 每年三月、六月、九月、十二月。 |

天数可以指定为一个月的天数或一周的天数。

使用这些选项，可以创建类似于以下示例的灵活计划：

| 想要的时间表                                                 | 要输入的值                                                   |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 每天 3 次（午夜、08:00 和 16:00）                            | months=*; days=*; hours=0/8 or 0,8,16; minutes=0 (Meaning: every day of every month, when hours=0/8/16 and minutes=0) |
| 每周一、周三和周五，晚上 8.30                                | months=*; days=mon,wed,fri; hours=20; minutes=30             |
| 每月的第 1 天和第 15 天，10 月至 6 月，上午 00:01            | months=oct-dec,jan-jun; days=1,15; hours=0; minutes=1        |
| 工作日内每 15 分钟一次，即周一至周五上午 8 点至晚上 7 点（08:00 - 19:00） | Note that this requires two tasks to achieve: (1) months=*; days=mon-fri; hours=8-18; minutes=*/15 (2) months=*; days=mon-fri; hours=19; minutes=0 We need the second scheduled item, to execute at 19:00, otherwise we would stop at 18:45. Another workaround would be to stop at 18:45 or 19:45 rather than 19:00. |

勾选仅复制快照匹配计划（**Only Replicate Snapshots Matching Schedule**）将复制限制为仅复制与复制计划同时创建的那些快照。

![](https://www.truenas.com/docs/images/CORE/12.0/TasksReplicationAddAdvancedSchedule.png)







































